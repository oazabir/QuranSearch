<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Quran Search</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/css/kfgqpc.font.css" />


    <style>
        .hafssmart {
            font-family: "hafssmart8"
        }

        .hafs {
            font-family: "hafs18"
        }

        .warsh {
            font-family: "warsh10"
        }

        .shouba {
            font-family: "shouba8"
        }

        .qaloon {
            font-family: "qaloon10"
        }

        .doori {
            font-family: "doori9"
        }

        .soosi {
            font-family: "soosi9"
        }

        .bazzi {
            font-family: "bazzi7"
        }

        .qumbul {
            font-family: "qumbul7"
        }

        @font-face {
            font-family: "hafssmart8";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/hafs-smart/font/hafssmart.8.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/hafs-smart/font/hafssmart.8.ttf") format("truetype");
        }

        @font-face {
            font-family: "hafs18";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/hafs/font/hafs.18.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/hafs/font/hafs.18.ttf") format("truetype");
        }

        @font-face {
            font-family: "warsh10";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/warsh/font/warsh.10.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/warsh/font/warsh.10.ttf") format("truetype");
        }

        @font-face {
            font-family: "shouba8";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/shouba/font/shouba.8.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/shouba/font/shouba.8.ttf") format("truetype");
        }

        @font-face {
            font-family: "qaloon10";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/qaloon/font/qaloon.10.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/qaloon/font/qaloon.10.ttf") format("truetype");
        }

        @font-face {
            font-family: "doori9";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/doori/font/doori.9.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/doori/font/doori.9.ttf") format("truetype");
        }

        @font-face {
            font-family: "soosi9";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/soosi/font/soosi.9.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/soosi/font/soosi.9.ttf") format("truetype");
        }

        @font-face {
            font-family: "bazzi7";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/bazzi/font/bazzi.7.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/bazzi/font/bazzi.7.ttf") format("truetype");
        }

        @font-face {
            font-family: "qumbul7";
            src: url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/qumbul/font/qumbul.7.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/thetruetruth/quran-data-kfgqpc@main/qumbul/font/qumbul.7.ttf") format("truetype");
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 20px;
        }

        #search_area {
            margin-bottom: 20px;
        }

        #search-input {
            padding: 8px;
            font-size: 20pt;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 300px;
            margin-right: 10px;
            font-variant-ligatures: no-common-ligatures;
        }

        #search-order,
        #search-uthmani,
        #search-exact,
        #search-regex {
            margin-right: 10px;
        }

        #search-query-explanation {
            margin-top: 10px;
            font-size: 10px;
            color: #666;
        }

        #autocomplete-container {
            border: 1px solid #ccc;
            padding: 10px;
            color: dimgray;
        }

        .highlight {
            background-color: yellow;
            font-weight: bold;
        }

        .autocomplete-items {
            margin-top: 10px;
        }

        .autocomplete-items div {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        .autocomplete-items a {
            font-weight: bold;
            color: #000;
            text-decoration: none;
            margin-right: 10px;
        }

        .autocomplete-items strong {
            font-size: 18px;
        }

        .autocomplete-items p {
            margin: 5px 0;

        }

        .ayah_link {
            display: inline-block;
        }

        .translation {
            color: dimgray;
        }

        .uthmani {
            font-size: 20pt;
            display: inline-block;
            color: darkgreen;
        }

        .simple {
            font-size: 10pt;
            color: gray;
        }

        .rtl {
            direction: rtl;
        }

        code {
            background-color: lightgray;
            color: black;
            padding: 3px;
            border-bottom: solid 1px #666;
        }

        li {
            line-height: 1.5em;
        }

        #query-examples {
            color: dimgray;
            border: solid 1px gray;
        }

        .search_example code {
            cursor: pointer;
        }

    </style>
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
    <script type="text/javascript" charset="UTF-8" src="json/quran.json"></script>
</head>

<body>
    <h1>Quran Search</h1>
    <div id="search_area">
        <input type="text" id="search-input" placeholder="e.g. ان ... هو" />
        <label title="Search the Quran backward, from last to first. Useful for finding matches in Juz Amma"><input type="checkbox" id="search-order" value="Reverse" checked="true"  />Last to first</label>
        <label title="Fuzzy match variants of alif, ya, waw, etc" ><input type="checkbox" id="search-fuzzy" value="Fuzzy" checked="true" />Fuzzy</label>
        <label title="Precisely match the Uthmani script only"><input type="checkbox" id="search-uthmani" value="Reverse" />Uthmani</label>
        <label title="Do exact match, no fuzzy stuff"><input type="checkbox" id="search-exact" value="Reverse" />Exact</label>
        <label title="Shows if search query is a valid regex"><input disabled="disabled" type="checkbox" id="search-regex" value="Regex" />Regex</label>
        <p id="search-query-explanation"></p>
    </div>
    <div id="autocomplete-container" class="autocomplete-items">

    </div>
    <div id="query-examples">
        <p>Example search queries. Click on the arabic to try the search:</p>
        <p>
        <ul class="examples">
            <li class="search_example"><code class="rtl" title="السما">السما</code> - Match any word having السما anywhere inside it. e.g. ٱلسَّمَآءِ ,ٱلسَّمَـٰوَٰتِ</li>
            <li class="search_example"><code class="rtl" title=" أن ">spaceأنspace</code> - Match أن as separate word</li>
            <li class="search_example"><code class="rtl" title="ان ... هو">ان ... هو</code> - Match ان/أن/إن followed by a space and three letter word and space
                class="search_example" and then هو</li>
            <li class="search_example"><code class="rtl" title="صلات">صلات</code> - Match صَلَاتِهِمْ، صَلَاتِى، ...</li>
            <li class="search_example"><code class="rtl" title="صلوة">صلوة</code> - Match صَلَاتِهِمْ،ٱلصَّلَوٰةَ ...</li>
            <li></li>
            <li></li>
        </ul>
        </p>
    </div>

    <script>
        const autocompleteContainer = document.getElementById('autocomplete-container');
        const searchResultsContainer = document.getElementById('search-results');

        const tashkeel = "\u0617-\u061A\u064B-\u0652\u0640\u0670\u0653\u06E5\u06E2\u0651\u0670";
        const mainArabicCharacters = "\u0621-\u064A\u0660-\u0669\u0671-\u06D5"
        const additionalArabicCharacters = "\u0615-\u061E\u064B-\u0660\u0640\u06D4-\u06ED\u0670";
        const regExArabicLettersOnly = new RegExp("[^\\s" + additionalArabicCharacters + "]", "gi");

        const regexChars = "\.\+\*\?\^\$\(\)\[\]\{\}\|\\";


        const verses = Object.values(quran);
        const reversedVerses = verses.toReversed();

        const searchInput = document.getElementById('search-input');
        const doSearch = _.debounce(() => search(searchInput.value), 500, false);
        searchInput.addEventListener('input', doSearch);
        [...document.getElementsByTagName('input')].forEach(e => e.addEventListener('change', doSearch));
        [...document.getElementsByClassName('search_example')].forEach(e => e.addEventListener('click', function(event){
            searchInput.value = event.srcElement.title;
            doSearch();
        }))

        function search(query) {
            const reverse = document.getElementById('search-order').checked;
            const searchQuery = query;
            var searchQueryExplanation = "Search using ";

            var searchQueryAsRegex = null;

            const isFuzzy = document.getElementById('search-fuzzy').checked;
            const isExact = document.getElementById('search-exact').checked;
            const isRegex = validateRegex(searchQuery);
            if (isRegex) {
                const regexQuery = isExact ? searchQuery : improveSearchQuery(searchQuery, isFuzzy);
                try {
                    searchQueryAsRegex = new RegExp(regexQuery, "g");
                    searchQueryExplanation += "Regex = <code class='rtl'>" + searchQueryAsRegex.toString() + "</code>";
                } catch (e) {
                    searchQueryAsRegex = null;
                    searchQueryExplanation += "Text = <code class='rtl'>" + searchQuery + "</code>";
                }
            } else {
                searchQueryExplanation += "Text = <code class='rtl'>" + searchQuery + "</code>";
            }
            document.getElementById('search-regex').checked = isRegex;

            const searchList = reverse ? reversedVerses : verses;

            if (isExact) searchQueryExplanation += " exact match ";
            if (reverse) searchQueryExplanation += " verses in reverse order ";

            const isUthmani = document.getElementById('search-uthmani').checked;
            searchQueryExplanation += isUthmani ? " matching uthmani script only " : " matching simple or uthmani scipt ";

            if (searchQuery.length > 1) {
                const matchingVerses = searchList.filter(v =>
                    isUthmani ?
                        matchText(v.uthmani, searchQuery, searchQueryAsRegex)
                        : matchText(v.simple, searchQuery, searchQueryAsRegex)
                        || matchText(v.uthmani, searchQuery, searchQueryAsRegex));

                showAutocomplete(matchingVerses, isUthmani, searchQuery, searchQueryAsRegex);
            } else {
                showAutocomplete([]);
            }

            document.getElementById('search-query-explanation').innerHTML = searchQueryExplanation;
        }

        function improveSearchQuery(query, isFuzzy) {
            //query = regExReplace(query, non_tashkeel, "$&[" + additionalArabicCharacters + "]{0,2}");
            query = query.replace(regExArabicLettersOnly, "$&[" + additionalArabicCharacters + "]{0,2}");
            if (isFuzzy) {
                query = query.replace(/ة/g, "[ةﺓﺔت]")
                    .replace(/[ا]/g, "[أاآإٱ]")
                    .replace(/و/g, "[وؤٶٷ]")
                    .replace(/ي/g, "[يىﻯﻰ]")
                    .replace(/ /g, "[ ]")
            }
            //query = query.replace("+", ".*?");
            return query;
        }

        function regExReplace(inputString, regexPattern, replacement) {
            let replacedString = "";
            let match;
            let startIndex = 0;

            while ((match = regexPattern.exec(inputString)) !== null) {
                const matchIndex = match.index;
                const theMatch = match[0];
                const matchLength = theMatch.length;

                replacedString +=
                    inputString.substring(startIndex, matchIndex) +
                    replacement.replace("$&", theMatch);

                startIndex += matchLength;
            }

            replacedString += inputString.substring(startIndex);

            return replacedString;
        }

        function matchText(verse, searchQuery, searchQueryAsRegex) {
            return (searchQueryAsRegex && searchQueryAsRegex.test(verse)) || verse.indexOf(searchQuery) > -1;
        }

        function validateRegex(pattern) {
            var parts = pattern.split('/'),
                regex = pattern,
                options = "";
            if (parts.length > 1) {
                regex = parts[1];
                options = parts[2];
            }
            try {
                new RegExp(regex, options);
                return true;
            }
            catch (e) {
                return false;
            }
        }

        function showAutocomplete(matchingVerses, isUthmani, searchQuery, searchQueryAsRegex) {
            autocompleteContainer.innerHTML = `<div class="result_count">Results ${matchingVerses.length}</div>`;

            matchingVerses.forEach(function (verse) {
                const verseItem = document.createElement('div');
                verseItem.innerHTML = `
                 <p class="ayah_link"><a target="_blank" href="https://quran.com/${verse.chapter}/${verse.verse}">(${verse.chapter}:${verse.verse})</a></p>
                 <p class="uthmani hafs">${showMatches(verse.uthmani, searchQuery, searchQueryAsRegex)}</p>
                 <p class="translation">${verse.translation}</p>
                 <p class="simple">${showMatches(verse.simple, searchQuery, searchQueryAsRegex)}</p>`;
                autocompleteContainer.appendChild(verseItem);
            });
        }

        function showMatches(verse, searchQuery, searchQueryAsRegex) {
            if (searchQueryAsRegex) {
                return highlightMatches(verse, searchQueryAsRegex);
            } else {
                return highlightMatches(verse, searchQuery);
            }
        }

        function highlightMatches(inputString, regexPattern) {
            // Create a new regular expression object
            var regex = new RegExp(regexPattern, 'gi');

            // Replace the matches with HTML span tags for highlighting
            var highlightedString = inputString.replace(regex, '<span class="highlight">$&</span>');

            // Return the highlighted string
            return highlightedString;
        }

    </script>
</body>

</html>
